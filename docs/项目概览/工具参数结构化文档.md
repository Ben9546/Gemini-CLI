# Gemini CLI 核心工具参数结构化文档

## 概述

本文档整理了 Gemini CLI 核心包中所有可用工具的参数配置信息，包括参数类型、描述、验证规则和使用示例。

## 工具分类

### 1. 文件操作工具

#### 1.1 ReadFileTool (read_file)
**功能**: 读取指定文件的内容，支持文本、图片和PDF文件

**参数结构**:
```typescript
interface ReadFileToolParams {
  absolute_path: string;  // 必需，文件的绝对路径
  offset?: number;        // 可选，开始读取的行号（0-based）
  limit?: number;         // 可选，读取的最大行数
}
```

**参数详情**:
- `absolute_path`: 文件的绝对路径，必须以 `/` 开头，必须在根目录内
- `offset`: 对于文本文件，开始读取的0基行号，需要与 `limit` 一起使用
- `limit`: 对于文本文件，最大读取行数，用于大文件分页

**验证规则**:
- 路径必须是绝对路径
- 路径必须在根目录内
- offset 必须是非负数
- limit 必须是正数
- 文件不能被 .geminiignore 忽略

#### 1.2 WriteFileTool (write_file)
**功能**: 向指定文件写入内容

**参数结构**:
```typescript
interface WriteFileToolParams {
  file_path: string;           // 必需，文件的绝对路径
  content: string;             // 必需，要写入的内容
  modified_by_user?: boolean;  // 可选，内容是否被用户修改
}
```

**参数详情**:
- `file_path`: 文件的绝对路径，必须在根目录内
- `content`: 要写入文件的内容
- `modified_by_user`: 标记内容是否被用户手动修改

**验证规则**:
- 路径必须是绝对路径
- 路径必须在根目录内
- 如果文件存在，不能是目录

#### 1.3 EditTool (replace)
**功能**: 在文件中替换文本内容

**参数结构**:
```typescript
interface EditToolParams {
  file_path: string;                    // 必需，文件的绝对路径
  old_string: string;                   // 必需，要替换的文本
  new_string: string;                   // 必需，替换后的文本
  expected_replacements?: number;       // 可选，期望的替换次数
  modified_by_user?: boolean;           // 可选，是否被用户修改
}
```

**参数详情**:
- `file_path`: 文件的绝对路径，必须以 `/` 开头
- `old_string`: 要替换的确切文本，建议包含前后3行上下文
- `new_string`: 替换后的确切文本
- `expected_replacements`: 期望的替换次数，默认为1

**验证规则**:
- 路径必须是绝对路径
- 路径必须在根目录内

#### 1.4 ReadManyFilesTool (read_many_files)
**功能**: 读取多个文件的内容并合并

**参数结构**:
```typescript
interface ReadManyFilesParams {
  paths: string[];                    // 必需，文件路径或目录路径数组
  include?: string[];                 // 可选，包含的glob模式
  exclude?: string[];                 // 可选，排除的glob模式
  recursive?: boolean;                // 可选，是否递归搜索
  useDefaultExcludes?: boolean;       // 可选，是否使用默认排除
  respect_git_ignore?: boolean;       // 可选，是否尊重.gitignore
}
```

**参数详情**:
- `paths`: 相对于目标目录的文件路径或glob模式数组
- `include`: 额外的包含模式，与paths合并
- `exclude`: 排除模式，添加到默认排除中
- `recursive`: 是否递归搜索，主要由glob模式中的 `**` 控制
- `useDefaultExcludes`: 是否应用默认排除模式
- `respect_git_ignore`: 是否尊重.gitignore模式

**默认排除模式**:
- `**/node_modules/**`
- `**/.git/**`
- `**/.vscode/**`
- `**/.idea/**`
- `**/dist/**`
- `**/build/**`
- `**/coverage/**`
- `**/__pycache__/**`
- `**/*.pyc`
- `**/*.bin`
- `**/*.exe`
- `**/*.dll`
- `**/*.so`
- `**/*.dylib`
- `**/*.class`
- `**/*.jar`
- `**/*.war`
- `**/*.zip`
- `**/*.tar`
- `**/*.gz`
- `**/*.bz2`
- `**/*.rar`
- `**/*.7z`
- `**/*.doc`
- `**/*.docx`
- `**/*.xls`
- `**/*.xlsx`
- `**/*.ppt`
- `**/*.pptx`
- `**/*.odt`
- `**/*.ods`
- `**/*.odp`
- `**/*.DS_Store`
- `**/.env`
- `**/GEMINI.md`

### 2. 文件搜索工具

#### 2.1 GrepTool (search_file_content)
**功能**: 在文件内容中搜索正则表达式模式

**参数结构**:
```typescript
interface GrepToolParams {
  pattern: string;    // 必需，正则表达式模式
  path?: string;      // 可选，搜索目录
  include?: string;   // 可选，文件包含模式
}
```

**参数详情**:
- `pattern`: 在文件内容中搜索的正则表达式模式
- `path`: 搜索目录的绝对路径，默认为当前工作目录
- `include`: 文件过滤的glob模式

**验证规则**:
- pattern 必须是有效的正则表达式
- path 必须在根目录内且存在

#### 2.2 GlobTool (glob)
**功能**: 使用glob模式查找文件

**参数结构**:
```typescript
interface GlobToolParams {
  pattern: string;              // 必需，glob模式
  path?: string;                // 可选，搜索目录
  case_sensitive?: boolean;     // 可选，是否大小写敏感
  respect_git_ignore?: boolean; // 可选，是否尊重.gitignore
}
```

**参数详情**:
- `pattern`: 匹配文件的glob模式
- `path`: 搜索目录的绝对路径，默认为根目录
- `case_sensitive`: 是否大小写敏感，默认为false
- `respect_git_ignore`: 是否尊重.gitignore模式，默认为true

**验证规则**:
- pattern 不能为空
- path 必须在根目录内且存在且为目录

### 3. 系统操作工具

#### 3.1 ShellTool (run_shell_command)
**功能**: 执行shell命令

**参数结构**:
```typescript
interface ShellToolParams {
  command: string;      // 必需，要执行的bash命令
  description?: string; // 可选，命令描述
  directory?: string;   // 可选，执行目录
}
```

**参数详情**:
- `command`: 要执行的bash命令，作为 `bash -c <command>` 执行
- `description`: 命令的简要描述，用于用户确认
- `directory`: 执行命令的目录，相对于项目根目录

**验证规则**:
- command 不能为空
- 必须能识别命令根目录
- directory 不能是绝对路径，必须存在

**输出信息**:
- Command: 执行的命令
- Directory: 执行目录
- Stdout: 标准输出
- Stderr: 标准错误
- Error: 错误信息
- Exit Code: 退出码
- Signal: 信号号
- Background PIDs: 后台进程ID
- Process Group PGID: 进程组ID

### 4. 网络工具

#### 4.1 WebFetchTool (web_fetch)
**功能**: 处理URL内容，包括本地和私有网络地址

**参数结构**:
```typescript
interface WebFetchToolParams {
  prompt: string;  // 必需，包含URL和指令的提示
}
```

**参数详情**:
- `prompt`: 包含URL（最多20个）和处理指令的综合提示

**验证规则**:
- prompt 不能为空
- 必须包含至少一个以 http:// 或 https:// 开头的URL

**功能特性**:
- 支持localhost和私有网络地址
- 自动转换GitHub blob URL为raw URL
- 超时时间：10秒
- 最大内容长度：100,000字符

#### 4.2 WebSearchTool (google_web_search)
**功能**: 使用Google搜索进行网络搜索

**参数结构**:
```typescript
interface WebSearchToolParams {
  query: string;  // 必需，搜索查询
}
```

**参数详情**:
- `query`: 要在网络上搜索的查询字符串

**验证规则**:
- query 不能为空

**输出特性**:
- 返回搜索结果和来源信息
- 支持引用标记
- 包含来源列表

### 5. 内存工具

#### 5.1 MemoryTool (save_memory)
**功能**: 保存信息到长期记忆

**参数结构**:
```typescript
interface SaveMemoryParams {
  fact: string;  // 必需，要记住的事实
}
```

**参数详情**:
- `fact`: 要保存的具体事实或信息

**验证规则**:
- fact 必须是非空字符串

**使用场景**:
- 用户明确要求记住某事
- 用户陈述关于自己的重要事实
- 用户偏好或环境信息

**存储位置**:
- 文件：`~/.gemini/GEMINI.md`
- 格式：Markdown列表项

### 6. MCP工具

#### 6.1 DiscoveredMCPTool
**功能**: 从MCP服务器发现和执行的工具

**参数结构**:
```typescript
type ToolParams = Record<string, unknown>;
```

**特性**:
- 动态发现MCP服务器提供的工具
- 支持服务器级别的信任配置
- 支持工具级别的白名单
- 可配置超时时间

**确认机制**:
- 服务器级别确认：`ProceedAlwaysServer`
- 工具级别确认：`ProceedAlwaysTool`
- 信任服务器：无需确认

### 7. 动态发现工具

#### 7.1 DiscoveredTool
**功能**: 通过项目发现命令动态发现的工具

**参数结构**:
```typescript
type ToolParams = Record<string, unknown>;
```

**特性**:
- 通过配置的发现命令动态发现工具
- 通过配置的调用命令执行工具
- 支持JSON格式的输入输出
- 提供详细的执行状态信息

**配置参数**:
- `discoveryCmd`: 工具发现命令
- `callCommand`: 工具调用命令

## 工具注册机制

### ToolRegistry 类

**主要方法**:
- `registerTool(tool: Tool)`: 注册工具定义
- `discoverTools()`: 发现项目中的工具
- `getFunctionDeclarations()`: 获取工具模式声明
- `getAllTools()`: 获取所有注册的工具
- `getToolsByServer(serverName: string)`: 获取特定MCP服务器的工具
- `getTool(name: string)`: 获取特定工具定义

**工具发现流程**:
1. 移除之前发现的工具
2. 执行配置的发现命令
3. 解析函数声明
4. 注册发现的工具
5. 发现MCP服务器工具

## 工具确认机制

### 确认类型

1. **ToolEditConfirmationDetails**: 文件编辑确认
   - 显示文件差异
   - 支持用户修改

2. **ToolExecuteConfirmationDetails**: 命令执行确认
   - 显示要执行的命令
   - 支持白名单机制

3. **ToolMcpConfirmationDetails**: MCP工具确认
   - 显示服务器和工具信息
   - 支持服务器和工具级别信任

4. **ToolInfoConfirmationDetails**: 信息确认
   - 显示提示信息
   - 可包含URL列表

### 确认结果

```typescript
enum ToolConfirmationOutcome {
  ProceedOnce = 'proceed_once',           // 执行一次
  ProceedAlways = 'proceed_always',       // 总是执行
  ProceedAlwaysServer = 'proceed_always_server', // 总是执行服务器工具
  ProceedAlwaysTool = 'proceed_always_tool',     // 总是执行特定工具
  ModifyWithEditor = 'modify_with_editor',       // 使用编辑器修改
  Cancel = 'cancel'                              // 取消
}
```

## 工具结果格式

### ToolResult 接口

```typescript
interface ToolResult {
  llmContent: PartListUnion;     // LLM历史内容
  returnDisplay: ToolResultDisplay; // 用户显示内容
}
```

### 特殊结果类型

- **FileDiff**: 文件差异显示
  ```typescript
  interface FileDiff {
    fileDiff: string;
    fileName: string;
  }
  ```

## 配置参数

### 工具发现配置
- `toolDiscoveryCommand`: 工具发现命令
- `toolCallCommand`: 工具调用命令
- `mcpServers`: MCP服务器配置
- `mcpServerCommand`: MCP服务器命令

### 文件操作配置
- `targetDir`: 目标目录
- `approvalMode`: 审批模式
- `fileService`: 文件服务配置

### 网络配置
- `geminiClient`: Gemini客户端配置
- 超时设置
- 内容长度限制

## 最佳实践

### 1. 参数验证
- 所有工具都应实现参数验证
- 使用SchemaValidator进行模式验证
- 提供清晰的错误信息

### 2. 路径安全
- 验证路径在根目录内
- 使用绝对路径
- 检查文件存在性和类型

### 3. 用户确认
- 危险操作需要用户确认
- 提供清晰的确认信息
- 支持白名单机制

### 4. 错误处理
- 提供详细的错误信息
- 区分验证错误和执行错误
- 记录操作指标

### 5. 性能优化
- 大文件使用分页读取
- 使用glob模式过滤文件
- 支持异步操作

## 扩展指南

### 添加新工具
1. 继承BaseTool类
2. 定义参数接口
3. 实现验证方法
4. 实现执行方法
5. 注册到ToolRegistry

### 工具发现
1. 实现发现命令
2. 返回FunctionDeclaration格式
3. 配置调用命令
4. 处理JSON输入输出

### MCP集成
1. 配置MCP服务器
2. 实现工具发现
3. 处理工具调用
4. 管理信任关系 