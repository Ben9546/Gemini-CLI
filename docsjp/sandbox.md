# Gemini CLI でのサンドボックス化

このドキュメントでは、前提条件、クイックスタート、設定など、Gemini CLI でのサンドボックス化に関するガイドを提供します。

## 前提条件

サンドボックス化を使用する前に、Gemini CLI をインストールしてセットアップする必要があります。

```bash
# npm で gemini-cli をインストールする
npm install -g @google/gemini-cli

# インストールを確認する
gemini --version
```

## サンドボックス化の概要

サンドボックス化は、潜在的に危険な操作（シェルコマンドやファイル変更など）をホストシステムから分離し、AI 操作と環境の間にセキュリティバリアを提供します。

サンドボックス化の利点は次のとおりです。

- **セキュリティ**:偶発的なシステム損傷やデータ損失を防ぎます。
- **分離**: ファイルシステムアクセスをプロジェクトディレクトリに制限します。
- **一貫性**: さまざまなシステム間で再現可能な環境を確保します。
- **安全性**: 信頼できないコードや実験的なコマンドを扱う際のリスクを軽減します。

## サンドボックス化の方法

理想的なサンドボックス化の方法は、プラットフォームや優先するコンテナソリューションによって異なる場合があります。

### 1. macOS Seatbelt (macOS のみ)

`sandbox-exec` を使用した軽量の組み込みサンドボックス化。

**デフォルトプロファイル**: `permissive-open` - プロジェクトディレクトリ外への書き込みを制限しますが、他のほとんどの操作は許可します。

### 2. コンテナベース (Docker/Podman)

完全なプロセス分離を備えたクロスプラットフォームのサンドボックス化。

**注意**: サンドボックスイメージをローカルでビルドするか、組織のレジストリから公開されているイメージを使用する必要があります。

## クイックスタート

```bash
# コマンドフラグでサンドボックス化を有効にする
gemini -s -p "コード構造を分析する"

# 環境変数を使用する
export GEMINI_SANDBOX=true
gemini -p "テストスイートを実行する"

# settings.json で設定する
{
  "sandbox": "docker"
}
```

## 設定

### サンドボックス化の有効化 (優先順位順)

1. **コマンドフラグ**: `-s` または `--sandbox`
2. **環境変数**: `GEMINI_SANDBOX=true|docker|podman|sandbox-exec`
3. **設定ファイル**: `settings.json` の `"sandbox": true`

### macOS Seatbelt プロファイル

組み込みプロファイル (`SEATBELT_PROFILE` 環境変数を介して設定):

- `permissive-open` (デフォルト): 書き込み制限、ネットワーク許可
- `permissive-closed`: 書き込み制限、ネットワークなし
- `permissive-proxied`: 書き込み制限、プロキシ経由のネットワーク
- `restrictive-open`: 厳格な制限、ネットワーク許可
- `restrictive-closed`: 最大限の制限

## Linux UID/GID の処理

サンドボックスは、Linux でのユーザー権限を自動的に処理します。これらの権限を上書きするには、次のようにします。

```bash
export SANDBOX_SET_UID_GID=true   # ホスト UID/GID を強制する
export SANDBOX_SET_UID_GID=false  # UID/GID マッピングを無効にする
```

## トラブルシューティング

### 一般的な問題

**"Operation not permitted" (操作は許可されていません)**

- 操作にはサンドボックス外へのアクセスが必要です。
- より寛容なプロファイルを試すか、マウントポイントを追加してください。

**コマンドが見つからない**

- カスタム Dockerfile に追加します。
- `sandbox.bashrc` を介してインストールします。

**ネットワークの問題**

- サンドボックスプロファイルがネットワークを許可しているか確認します。
- プロキシ設定を確認します。

### デバッグモード

```bash
DEBUG=1 gemini -s -p "デバッグコマンド"
```

### サンドボックスの検査

```bash
# 環境を確認する
gemini -s -p "シェルコマンドを実行: env | grep SANDBOX"

# マウントを一覧表示する
gemini -s -p "シェルコマンドを実行: mount | grep workspace"
```

## セキュリティに関する注意

- サンドボックス化はすべてのリスクを軽減しますが、排除するわけではありません。
- 作業を許可する最も制限の厳しいプロファイルを使用してください。
- コンテナのオーバーヘッドは、最初のビルド後は最小限です。
- GUI アプリケーションはサンドボックスでは動作しない場合があります。

## 関連ドキュメント

- [設定](./cli/configuration.md): 完全な設定オプション。
- [コマンド](./cli/commands.md): 利用可能なコマンド。
- [トラブルシューティング](./troubleshooting.md): 一般的なトラブルシューティング。
